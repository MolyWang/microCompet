---
title: "Introduction to microCompet"
author: "Zhuyi Wang"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to microCompet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(knitr)
opts_chunk$set(fig.align = "center", 
               out.width = "50%",
               fig.width = 1, fig.height = 0.8,
               dev.args=list(pointsize=10),
               par = TRUE, # needed for setting hook 
               collapse = TRUE, # collapse input & output code in chunks
               warning = FALSE)
knit_hooks$set(par = function(before, options, envir)
  { if(before && options$fig.show != "none") 
       par(family = "sans", mar=c(4.1,4.1,1.1,1.1), mgp=c(3,1,0), tcl=-0.5)
})
set.seed(1) # for exact reproducibility
```

__*Welcome to the world of microbes and microbiota!*__

<img src="../inst/extdata/microbiome.jpg" height="400px" width="600px"/>


```{r, eval=FALSE}
- Introduction
- Available Datasets
- Available Functions
- References
```


## Introduction
_*microCompet*_ is a package for visualizing potential microbial competition for simple sugars as sources of nutrition and energy. It can plot all pathways one microbe has, evaluate each pathway's completeness, and compare across species to score the potential for competition. 

To use this package, the only required input from users is a microbial genome in the format of an *__ANNOTATED__ GenBank file*. By annotated, this means "genes" are labeled onto a genome, and the file is not one very very very long line of ATCG. See provided files in the main directory for example, Klebsiella_variicola.gb, Lactobacillus_johnsonii.gb. (Microbe names are hard to pronounce, but it's harder to resist the temptation to try!). __*Download sample genbank(.gb) files to your working directory*__, so the later examples can run smoothly.

The first step is to load the library, and following this vignettes do not require any other user input.
```{r, eval=FALSE}
library("microCompet")
# and load all dependencies
require("radarchart")
require("ggraph")
require("network")
require("sna")
require("ggplot2")
require("igraph")
require("dplyr")
```


## Available Datasets
__1. EnzymaticReactions__

Each row in this dataset uses 6 attributes to describe an enzymatic reaction.

If a reaction equation is substrate1 ---> product1, catalyzed by enzyme E1. Now we obviously have *Substrate*, *Product*, and *Enzyme*. *Gene* is the name of a gene that encodes enzyme E1, and different microbial species may different genes encoding slightly different versions E1. *Reaction.EC* is a universal naming system for enzymes based on the category of reaction it catalyzed, full version is Enzyme Commission, usually in the form of 2.7.1.55. The last *Sugar* is to describe which sugar this enzyme involves in degrading.

If a reaction is substrate1 ---> product1 + product2, then they are written as two separate lines with one product per line (all other attributes would be the same). This is for easier network presentation.


__2. EnzymeDistribution__

Each row describes one gene/enzye and its distribution in microbes. The first 4 columns *Gene*, *Reaction.EC*, *Enzyme*, *Sugar* are the same as described in __EnzymaticReactions__. While column 5 to 13 describe 9 genomes. These 9 species are named by first letter of genus and first four letters of species, thus Klebsiella variicola is "Kvari". Check their full name by:
```{r, eval=FALSE}
colnames(EnzymeDistribution)[5:13]
```
A "0" suggest this species/genome does not encode the gene in the row, while "1" suggests it's encoded.


__Attention for self-defined dataseets__
If you read in a data frame from a csv, tsv, excel file, be careful about empty spaces in the cell. All functions used here are sensitive the spaces, and "ribose" and "ribose " is not considered as the same sugar. You can call the trim() function in excel before saving the dataset.

## Available Functions
__1. extractCarboGenes__

When use provide a full path to a gbk file, and a list of potentially sugar degradation genes of interest, this function extract available carbo_genes from the file. There are other avilable gbk-parsing packages available, but they usually format the whole file (about 20M for one microbe) into one very object, which is very slow and provides unused information for this package. 

Function extractCarboGenes simply screen over the file, extract all lines in the format "/gene="gene_name" and select ones in the list of genes provided by users. See example with 
```{r, eval=FALSE}
require("microCompet")
# load package dataset
ED <- microCompet::EnzymeDistribution
# Will include all sugar degradation genes for this example
full_enzyme_gene_lst <- ED$Gene
# Uncommet if you have the file in your working directory
# otherwise replace the . with path to the directory
genome_file_path <- "./Lactobacillus_johnsonii.gb"
carbo_genes <- extractCarboGenes(genome_file_path, full_enzyme_gene_lst)
carbo_genes

```
__2. constructFullNetwork__

This function offers to visualize the all sugar degradation pathways of a microbial genome. The three arguments are name of a microbe, a full list of sugar degradation enzymes (output from extractCarboGenes), and a dataset with all reactions of interest (See __*EnzymaticReactions*__ for example and descriptions). A sample can be produced by:
```{r, eval=FALSE}
# No need to run the commented lines if you've run the previous example.
# require("microCompet")
# ED <- microCompet::EnzymeDistribution
# full_enzyme_gene_lst <- ED$Gene
# genome_file_path <- "./Lactobacillus_johnsonii.gb"
# carbo_genes <- microCompet::extractCarboGenes(genome_file_path, full_enzyme_gene_lst)
ER <- microCompet::EnzymaticReactions
full_pathway <- microCompet::constructFullNetwork("L. johnsonii", carbo_genes, ER)
full_pathway
```

Don't be scared by many legends, they would make sense after explanation :D

Each vertex is an intermediate compound that appears in the pathway, while each edge suggest enzymes/genes that can catalyze this reaction (tail as substrate and head as product).

_Size of a vertex_ implies its importance in the pathway, compounds that involve in more reactions are larger. _Color of an edge_ identifies the sugar degradation pathway it participates in, and _width of an edge_ indicates number of genes encoding an enzyme that can catalyze this reaction.

Enzyme name or reaction EC for each edge is not labeled. Though this sample figure look quite empty, a species within the _Escherichia_ or _Klebsiella_ genus can usually degrade many different sugars and this image might be too busy. In addition, enzyme versions do not contribute very much to the basic understanding sugar degradation capacity of a bacterial species.

Try this function with _Klebsiella_variicola.gb_ or other annotated gbk files. (Check NCBI)

__3. overallSimilarity__

Given a genome of interest (represented by a list of gene names) and an expression profile of some other species (must be offered in a dataframe following the format of __*EnzymeDistribution*__), this function compares the overall similarity of the genome of interest with other species and produce a radar chart. See example
```{r, eval=FALSE}
# library("microCompet")
# genome_name <- "L. johnsonii"
# full_enzyme_gene_lst <- ED$Gene
# genome_file_path <- "./Lactobacillus_johnsonii.gb"
# carbo_genes <- extractCarboGenes(genome_file_path, full_enzyme_gene_lst)
# check ED with head(ED)
ED <- microCompet::EnzymeDistribution
# check ED with 
# head(ED)
overall_similarity <- overallSimilarity(genome_name, carbo_genes, ED, 5, 13)
overall_similarity
```
<img src="../inst/extdata/overSimi1.png" height="500px" width="600px"/>

The full score is the total number of enzymes in the provided dataset. Common features is either "both genome express one enzyme" or "neither express it". One common feature adds 1 to the similarity score, and the radar chart visually tells you which species might be the strongest competitor (most similar). To see full name of each species on the corner, check out the description file for _EnzymeDistribution_ by
```{r, eval=FALSE}
?EnzymeDistribution
```

__4. competeMicrobiota__

The last function is to show potential microbial competition for various sugars. Each corner is a potential sugar degradation pathway, the the score is the relative completeness of this pathway, calculated as available enzymes divided by total enzymatic steps (different versions of the same enzyme are counted as the same for this function).

Run the code, play with the interactive plot, and compare your favourite ones.

```{r, eval=FALSE}
#  library("microCompet")
#  genome_name <- "L. johnsonii"
#  full_enzyme_gene_lst <- ED$Gene
#  genome_file_path <- "./Lactobacillus_johnsonii.gb"
#  carbo_genes <- extractCarboGenes(genome_file_path, full_enzyme_gene_lst)
ED <- microCompet::EnzymeDistribution
first_microbe <- 5
last_microbe <- 13
ER <- microCompet::EnzymaticReactions
compete_microbiota <- competeMicrobiota(genome_name, carbo_genes, ER,
                                        ED, first_microbe, last_microbe)
compete_microbiota
```
<img src="../inst/extdata/comp1.png" height="400px" width="700px"/>
<img src="../inst/extdata/comp2.png" height="400px" width="700px"/>

## Yeah!

Now you understand how to play with this package, have fun!

## References

1. Butts, C. 2008. “network: a Package for Managing Relational Data in R.” _Journal of Statistical Software_. 24(2). <URL: https://www.jstatsoft.org/v24/i02/paper>.

2. Butts, C. 2020. network: Classes for Relational Data. The Statnet Project (<URL:http://www.statnet.org>). R package version 1.16.1, <URL: https://CRAN.R-project.org/package=network>.

3. Butts, C.T. 2020. sna: Tools for Social Network Analysis. R package version 2.6. https://CRAN.R-project.org/package=sna

4. Csardi, G., Nepusz, T. 2006. The igraph software package for complex network research, InterJournal, Complex Systems 1695. https://igraph.org

5. Emery Pharma. A Fascination for the Human Microbiome for a Healthier Life. https://emerypharma.com/blog/human_microbiome_healthier_life/ 

6. Karp, P.D., Riley, M., Paley, S.M., and Pellegrini-Toole A. 2002. The MetaCyc Database. *Nucleic Acids Res*. 30(1):59-61. doi:10.1093/nar/30.1.59

7. National Center for Biotechnology Information (NCBI)[Internet]. Bethesda (MD): National Library of Medicine (US), National Center for Biotechnology Information; [1988]. Available from: https://www.ncbi.nlm.nih.gov/

8. Pedersen, T.L. 2020. ggraph: An Implementation of Grammar of Graphics for Graphs and Networks. R package version 2.0.3. https://CRAN.R-project.org/package=ggraph

9. R Core Team. 2020. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL: https://www.R-project.org/.

10. Wickham, H. 2016. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York.
